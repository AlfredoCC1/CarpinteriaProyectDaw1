<div id="view-empleados" class="view-container">

  <!-- ERROR -->
  <div *ngIf="error" class="alert alert-danger py-2">
    {{ error }}
  </div>

  <!-- ================= FORM REGISTRAR ================= -->
  <div class="form-view" data-aos="fade-up">
    <div class="form-header">
      <h3>Registrar Empleado</h3>
      <small>Completa los datos del trabajador</small>
    </div>

    <!--  ENTER NO GUARDA -->
    <form
      id="form-empleado"
      (ngSubmit)="guardar()"
      (keydown.enter)="$event.preventDefault()"
    >
      <div class="row g-4">

        <div class="col-md-3">
          <label class="form-label">C贸digo</label>
          <input
            type="text"
            class="form-control"
            name="codigoTrabajador"
            [(ngModel)]="form.codigoTrabajador"
            placeholder="Ej: JPEREZ123"
            required
            maxlength="20"
          >
        </div>

        <div class="col-md-3">
          <label class="form-label">Rol</label>
          <select
            class="form-select"
            name="idRol"
            [(ngModel)]="form.idRol"
            required
          >
            <option value="">Seleccionar...</option>
            <option *ngFor="let r of roles" [value]="r.idRol">
              {{ r.nombre }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">DNI</label>
          <input
            type="text"
            class="form-control"
            name="dni"
            [(ngModel)]="form.dni"
            placeholder="12345678"
            required
            maxlength="15"
          >
        </div>

        <div class="col-md-3">
          <label class="form-label">Celular</label>
          <input
            type="text"
            class="form-control"
            name="celular"
            [(ngModel)]="form.celular"
            placeholder="999888777"
            maxlength="20"
          >
        </div>

        <div class="col-md-6">
          <label class="form-label">Nombres</label>
          <input
            type="text"
            class="form-control"
            name="nombre"
            [(ngModel)]="form.nombre"
            required
            maxlength="100"
          >
        </div>

        <div class="col-md-6">
          <label class="form-label">Apellidos</label>
          <input
            type="text"
            class="form-control"
            name="apellidos"
            [(ngModel)]="form.apellidos"
            required
            maxlength="150"
          >
        </div>

        <div class="col-md-6">
          <label class="form-label">Correo</label>
          <input
            type="email"
            class="form-control"
            name="correo"
            [(ngModel)]="form.correo"
            required
            maxlength="100"
          >
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha nacimiento</label>
          <input
            type="date"
            class="form-control"
            name="fechaNacimiento"
            [(ngModel)]="form.fechaNacimiento"
            required
          >
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha contrataci贸n</label>
          <input
            type="date"
            class="form-control"
            name="fechaContratacion"
            [(ngModel)]="form.fechaContratacion"
            required
          >
        </div>

        <div class="col-md-4">
          <label class="form-label">G茅nero</label>
          <select
            class="form-select"
            name="genero"
            [(ngModel)]="form.genero"
          >
            <option value="">Seleccionar...</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="col-md-8">
          <label class="form-label">Direcci贸n</label>
          <input
            type="text"
            class="form-control"
            name="direccion"
            [(ngModel)]="form.direccion"
            maxlength="255"
          >
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-warning" [disabled]="loading">
            <i class="fa-solid fa-save me-2"></i> Guardar Empleado
          </button>
        </div>

      </div>
    </form>
  </div>

  <!-- ================= TABLA ================= -->
  <div class="table-view" data-aos="fade-up" data-aos-delay="100">
    <div class="table-header">
      <h4>EMPLEADOS REGISTRADOS</h4>

      <div class="table-actions">

        <!--  BUSCADOR -->
        <div class="input-group input-group-sm" style="width: 300px;">
          <span class="input-group-text">
            <i class="fa-solid fa-search"></i>
          </span>

          <input
            type="text"
            class="form-control"
            placeholder="Buscar por nombre, DNI, c贸digo..."
            [(ngModel)]="textoBuscar"
            [ngModelOptions]="{ standalone: true }"
            (keydown.enter)="$event.preventDefault(); listar()"
          >

          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="listar()"
          >
            Buscar
          </button>
        </div>

        <!-- FILTRO ROL -->
        <select
          class="form-select form-select-sm"
          style="width: 170px;"
          [(ngModel)]="filtroRol"
          [ngModelOptions]="{ standalone: true }"
          (change)="listar()"
        >
          <option value="">Todos los roles</option>
          <option *ngFor="let r of roles" [value]="r.idRol">
            {{ r.nombre }}
          </option>
        </select>

      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 table-empleados">
        <thead>
        <tr>
          <th>ID</th>
          <th>CDIGO</th>
          <th>EMPLEADO</th>
          <th>ROL</th>
          <th>DNI</th>
          <th>CORREO</th>
          <th>CELULAR</th>
          <th class="text-end">ACCIONES</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let e of empleados">
          <td>{{ e.idEmpleado }}</td>
          <td>{{ e.codigoTrabajador }}</td>
          <td>
            <strong>{{ e.nombre }} {{ e.apellidos }}</strong><br>
            <small class="text-muted">
              Ingreso: {{ e.fechaContratacion }}
            </small>
          </td>
          <td>{{ e.rol?.nombre }}</td>
          <td>{{ e.dni }}</td>
          <td>{{ e.correo }}</td>
          <td>{{ e.celular || '-' }}</td>
          <td class="text-end">
            <button
              class="btn btn-sm btn-outline-primary me-1"
              data-bs-toggle="modal"
              data-bs-target="#modalEditarEmpleado"
              (click)="abrirEditar(e)"
            >
              <i class="fa-solid fa-pen"></i>
            </button>

            <button
              class="btn btn-sm btn-outline-danger"
              (click)="eliminar(e.idEmpleado)"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>

        <tr *ngIf="!loading && empleados.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            No hay empleados para mostrar.
          </td>
        </tr>
        </tbody>


        <!-- MODAL EDITAR -->
        <div class="modal fade" id="modalEditarEmpleado" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form (ngSubmit)="actualizar()" #fEdit="ngForm" (keydown.enter)="$event.preventDefault()">

                <div class="modal-header">
                  <h5 class="modal-title">Editar empleado</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                  <div class="row g-3">

                    <!-- C贸digo trabajador -->
                    <div class="col-md-6">
                      <label class="form-label">C贸digo trabajador</label>
                      <input class="form-control"
                             [(ngModel)]="edit.codigoTrabajador"
                             name="editCodigoTrabajador"
                             required>
                    </div>

                    <!-- Rol -->
                    <div class="col-md-6">
                      <label class="form-label">Rol</label>
                      <select class="form-select"
                              [(ngModel)]="edit.idRol"
                              name="editIdRol"
                              required>
                        <option [ngValue]="''" disabled>Seleccione...</option>
                        <option *ngFor="let r of roles" [ngValue]="r.idRol">
                          {{ r.nombre }}
                        </option>
                      </select>
                    </div>

                    <!-- DNI -->
                    <div class="col-md-6">
                      <label class="form-label">DNI</label>
                      <input class="form-control"
                             [(ngModel)]="edit.dni"
                             name="editDni"
                             maxlength="15"
                             required>
                    </div>

                    <!-- Celular -->
                    <div class="col-md-6">
                      <label class="form-label">Celular</label>
                      <input class="form-control"
                             [(ngModel)]="edit.celular"
                             name="editCelular"
                             maxlength="20"
                             required>
                    </div>

                    <!-- Nombre -->
                    <div class="col-md-6">
                      <label class="form-label">Nombres</label>
                      <input class="form-control"
                             [(ngModel)]="edit.nombre"
                             name="editNombre"
                             required>
                    </div>

                    <!-- Apellidos -->
                    <div class="col-md-6">
                      <label class="form-label">Apellidos</label>
                      <input class="form-control"
                             [(ngModel)]="edit.apellidos"
                             name="editApellidos"
                             required>
                    </div>

                    <!-- Correo -->
                    <div class="col-md-12">
                      <label class="form-label">Correo</label>
                      <input class="form-control"
                             type="email"
                             [(ngModel)]="edit.correo"
                             name="editCorreo"
                             required>
                    </div>

                    <!-- Fecha nacimiento -->
                    <div class="col-md-6">
                      <label class="form-label">Fecha nacimiento</label>
                      <input class="form-control"
                             type="date"
                             [(ngModel)]="edit.fechaNacimiento"
                             name="editFechaNacimiento"
                             required>
                    </div>

                    <!-- Fecha contrataci贸n -->
                    <div class="col-md-6">
                      <label class="form-label">Fecha contrataci贸n</label>
                      <input class="form-control"
                             type="date"
                             [(ngModel)]="edit.fechaContratacion"
                             name="editFechaContratacion"
                             required>
                    </div>


                    <!-- Direcci贸n -->
                    <div class="col-md-6">
                      <label class="form-label">Direcci贸n</label>
                      <input class="form-control"
                             [(ngModel)]="edit.direccion"
                             name="editDireccion"
                             required>
                    </div>
                  </div>

                  <!-- Mensaje de error si usas this.error -->
                  <div class="alert alert-danger mt-3" *ngIf="error">
                    {{ error }}
                  </div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                  </button>
                  <button class="btn btn-primary"
                          type="submit"
                          [disabled]="loading || fEdit.invalid">
                    Guardar cambios
                  </button>
                </div>

              </form>
            </div>
          </div>
        </div>


      </table>
    </div>
  </div>
</div>
